# springboot-keycloak-openldap

## Goal

The goal of this project is to create a simple REST API and securing it with Keycloak. Furthermore, Keycloak's users will be loaded from a OpenLDAP server.

## Start Environment

### Docker Compose

1. Open one terminal

2. Inside `/springboot-keycloak-openldap/dev` folder run
```
docker-compose up
```

### Configuring LDAP

1. Access the link
```
https://localhost:6443
```

2. Login with the credentials
```
Login DN: cn=admin,dc=mycompany,dc=com
Password: admin
```

3. Import the file `/src/main/resources/ldap-mycompany-com.ldif`

This file has already a pre-defined structure for mycompany.com.
Basically, it has 2 groups (developers and admin) and 4 users (Bill Gates, Steve Jobs, Mark Cuban and Ivan Franchin). Besides, it is defined that Bill Gates, Steve Jobs and Mark Cuban belong to developers group and Ivan Franchin belongs to admin group.
```
Bill Gates > username: bgates, password: 123
Steve Jobs > username: sjobs, password: 123
Mark Cuban > username: mcuban, password: 123
Ivan Franchin > username: ifranchin, password: 123
```

### Configuring Keycloak

1. Access the link
```
http://localhost:8181
```

2. Login with the credentials
```
Username: admin
Password: admin
```

3. Create a new Realm
- Go to top-left corner and hover the mouse over `Master` realm. A blue button `Add realm` will appear. Click on it.
- On `Name` field, write `company-services`. Click on `Create`.

4. Create a new Client
- Click on `Clients` menu on the left.
- Click `Create` button.
- On `Client ID` field type `springboot-keycloak-openldap`.
- Click on `Save`.
- On `Settings` tab, set the `Access Type` to `confidential`
- Still on `Settings` tab, set the `Valid Redirect URIs` to `http://localhost:8080/*`
- Click on `Save`.
- Go to `Credentials` tab. Copy the value on `Secret` field. It will be used on the next steps.

5. Create a new Role
- Click on `Roles` menu on the left.
- Click `Add Role` button.
- On `Role Name` type `user`.
- Click on `Save`.

6. LDAP Integration
- Click on the `User Federation` menu on the left.
- Select `ldap`.
- On `Vendor` field select `Other`
- On `Connection URL` type `ldap://<ldap-service_ip-address>`. To get the ldap-service ip address run the following docker command:
```
docker inspect -f "{{ .NetworkSettings.Networks.dev_default.IPAddress }}" ldap-service
```
- Click on `Test connection` to check if it is ok.
- On `Users DN` type `ou=users,dc=mycompany,dc=com`
- On `Bind DN` type `cn=admin,dc=mycompany,dc=com`
- On `Bind Credential` set `admin`
- Click on `Test authentication` to check if it is ok.
- On `Custom User LDAP Filter` set `(gidnumber=500)` to just get developers.
- Click on `Save`.
- Click on `Synchronize all users`.

7. Configure users imported
- Click on `Users` menu on the left.
- Click on `View all users`. 3 users will be shown.
- Edit user `bgates`.
- Go to `Role Mappings` tab and add role `user` to him.
- Do the same for the user `sjobs`.
- Let's leave `mcuban` without `user` role.

### Spring Boot Application

1. Back to some terminal and start `springboot-keycloak-openldap` application

In `springboot-keycloak-openldap` root folder, run those 2 commands:
```
mvn clean package
java -jar target/springboot-keycloak-openldap-0.0.1-SNAPSHOT.jar
```

## Test using cUrl

1. Open a new terminal

2. Call the endpoint `GET /api/public` using the cURL command bellow.
```
curl -i 'http://localhost:8080/api/public'
```

It will return:
```
Code: 200
Response Body: It is public.
```

3. Try to call the endpoint `GET /api/private` using the cURL command bellow.
``` 
curl -i 'http://localhost:8080/api/private'
```

It will return:
```
Code: 302
```

4. Export to a variable the client secret generated by Keycloak for `springboot-keycloak-openldap` (Configuring Keycloak, step 4).
```
export KEYCLOAK_CLIENT_SECRET=<keycloak-client-secret>
```

5. Run the command bellow to get an access token for `bgates` user.
```
MYCOMPANY_BGATES_ACCESS_TOKEN="Bearer $(curl -s -X POST \
  "http://localhost:8181/auth/realms/company-services/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=bgates" \
  -d "password=123" \
  -d "grant_type=password" \
  -d "client_secret=$KEYCLOAK_CLIENT_SECRET" \
  -d "client_id=springboot-keycloak-openldap" | jq -r .access_token)"
```

6. Call the endpoint `GET /api/private` using the cURL command bellow.
```
curl -i "http://localhost:8080/api/private" -H "authorization: $MYCOMPANY_BGATES_ACCESS_TOKEN"
```

It will return:
```
Code: 200
Response Body: bgates, it is private.
```

7. Run the command bellow to get an access token for `mcuban` user.
```
MYCOMPANY_MCUBAN_ACCESS_TOKEN="Bearer $(curl -s -X POST \
  "http://localhost:8181/auth/realms/company-services/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=mcuban" \
  -d "password=123" \
  -d "grant_type=password" \
  -d "client_secret=$KEYCLOAK_CLIENT_SECRET" \
  -d "client_id=springboot-keycloak-openldap" | jq -r .access_token )"
```

8. Try to call the endpoint `GET /api/private` using the cURL command bellow.
```
curl -i "http://localhost:8080/api/private" -H "authorization: $MYCOMPANY_MCUBAN_ACCESS_TOKEN"
```

As mcuban doesn't have the `user` role, he cannot access this endpoint. The endpoint return will be:
```
Code: 403
Response Body: {"timestamp":1524556466611,"status":403,"error":"Forbidden","message":"Access is denied","path":"/api/private"}
```

9. Go to Keycloak and add the role `user` to the `mcuban` user.

10. Run the command on `step 7)` again to get a new access token for `mcuban` user.

11. Call again the endpoint `GET /api/private` using the cURL command presented on `step 8`.
It will return:
```
Code: 200
Response Body: mcuban, it is private.
```

## Using `client_id` and `client_secret` to get access token

You can get an access token to `springboot-keycloak-openldap` using `client_id` and `client_secret`

1. Stop `springboot-keycloak-openldap` application.

2. Start it again, informing `-Dclient_secret`

*Update the `KEYCLOAK_CLIENT_SECRET` value with the secret generated by Keycloak (Configuring Keycloak, step 4)*

```
KEYCLOAK_CLIENT_SECRET=232dc622-ee81-4025-a911-7f122d7b86e7

curl -s -X POST \
  "http://localhost:8181/auth/realms/company-services/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials" \
  -d "client_secret=$KEYCLOAK_CLIENT_SECRET" \
  -d "client_id=springboot-keycloak-openldap" | jq -r .access_token

exit
```

## Test using Swagger

1. Access the link
```
https://localhost:8080/swagger-ui.html
```

2. Click on `GET /api/public` to open it. Then, click on `Try it out` button and, finally, click on `Execute` button
It will return:
```
Code: 200
Response Body: It is public.
```

3. Now click on `GET /api/private`, it is a secured endpoint. Let's try it without authentication.

4. Click on `Try it out` button and then on `Execute` button
It will return:
```
TypeError: Failed to fetch
```

5. In order to access the private endpoint, you need an access token. To get it, run the following commands in a terminal.
**P.S.** replace `<keycloak-client-secret>` by the client secret generated by Keycloak for `springboot-keycloak-openldap`
```
export KEYCLOAK_CLIENT_SECRET=<keycloak-client-secret>

MYCOMPANY_BGATES_ACCESS_TOKEN="Bearer $(curl -s -X POST \
  "http://localhost:8181/auth/realms/company-services/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" -d "username=bgates" -d "password=123" \
  -d "grant_type=password" -d "client_secret=$KEYCLOAK_CLIENT_SECRET" \
  -d "client_id=springboot-keycloak-openldap" | jq -r .access_token)"
  
echo $MYCOMPANY_BGATES_ACCESS_TOKEN 
```

6. Copy (`Ctr-C`) the token generated (something like that starts with `Bearer ...`) and go back to `Swagger`

7. Click on the `Authorize` button, paste (`Ctr-V`) the copied token in the value field and. Then, click on `Authorize` and, to finalize, click on `Done`.

8. Go to `GET /api/private`, click on `Try it out` and then on `Execute` button
It will return:
```
Code: 200
Response Body: bgates, it is private.
```

9. The token default expiration period is `5 minutes`. So, wait this time and, using the same token, try to call the private endpoint.
It will return:
```
Code: 401
Response Body:
{
  "timestamp": 1523395954815,
  "status": 401,
  "error": "Unauthorized",
  "message": "Unable to authenticate using the Authorization header",
  "path": "/api/private"
}
```